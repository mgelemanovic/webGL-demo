function createBufferFromData(a,b,c){var d=GL.createBuffer();return GL.bindBuffer(GL.ARRAY_BUFFER,d),GL.bufferData(GL.ARRAY_BUFFER,new Float32Array(a),GL.STATIC_DRAW),d.itemSize=b,d.numItems=c,d}function initBuffers(){var a=[-squareVertexDistance,squareVertexDistance,0,squareVertexDistance,squareVertexDistance,0,-squareVertexDistance,-squareVertexDistance,0,squareVertexDistance,-squareVertexDistance,0],b=[0,1,1,1,0,0,1,0];return{position:createBufferFromData(a,3,4),textureCoord:createBufferFromData(b,2,4)}}function webGLStart(){canvas=document.getElementById("webgl-context"),GL=initGL(),shaderProgram=initShaders(),vertexBuffer=initBuffers(),GL.clearColor(0,0,0,1),GL.viewport(0,0,GL.viewportWidth,GL.viewportHeight),GL.enable(GL.BLEND),GL.blendFunc(GL.SRC_ALPHA,GL.ONE_MINUS_SRC_ALPHA),GL.bindBuffer(GL.ARRAY_BUFFER,vertexBuffer.position),GL.vertexAttribPointer(shaderProgram.vertexPositionAttribute,vertexBuffer.position.itemSize,GL.FLOAT,!1,0,0),GL.bindBuffer(GL.ARRAY_BUFFER,vertexBuffer.textureCoord),GL.vertexAttribPointer(shaderProgram.textureCoordAttribute,vertexBuffer.textureCoord.itemSize,GL.FLOAT,!1,0,0)}function initGL(){var a;try{a=canvas.getContext("experimental-webgl"),a.viewportWidth=canvas.width,a.viewportHeight=canvas.height}catch(b){}return a?a:(alert("Could not initialise WebGL, sorry :-("),null)}function mvPushMatrix(){var a=mat4.create();mat4.copy(a,mvMatrix),mvMatrixStack.push(a)}function mvPopMatrix(){if(0==mvMatrixStack.length)throw"Invalid popMatrix!";mvMatrix=mvMatrixStack.pop()}function getShader(a,b){var c=document.getElementById(b);if(!c)return null;for(var d="",e=c.firstChild;e;)3==e.nodeType&&(d+=e.textContent),e=e.nextSibling;var f;if("x-shader/x-fragment"==c.type)f=a.createShader(a.FRAGMENT_SHADER);else{if("x-shader/x-vertex"!=c.type)return null;f=a.createShader(a.VERTEX_SHADER)}return a.shaderSource(f,d),a.compileShader(f),a.getShaderParameter(f,a.COMPILE_STATUS)?f:(alert(a.getShaderInfoLog(f)),null)}function initShaders(){var a=getShader(GL,"shader-fs"),b=getShader(GL,"shader-vs"),c=GL.createProgram();return GL.attachShader(c,b),GL.attachShader(c,a),GL.linkProgram(c),GL.getProgramParameter(c,GL.LINK_STATUS)||alert("Could not initialise shaders"),GL.useProgram(c),c.vertexPositionAttribute=GL.getAttribLocation(c,"aVertexPosition"),GL.enableVertexAttribArray(c.vertexPositionAttribute),c.textureCoordAttribute=GL.getAttribLocation(c,"aTextureCoord"),GL.enableVertexAttribArray(c.textureCoordAttribute),c.pMatrixUniform=GL.getUniformLocation(c,"uPMatrix"),c.mvMatrixUniform=GL.getUniformLocation(c,"uMVMatrix"),c.samplerUniform=GL.getUniformLocation(c,"uSampler"),c}function startGame(){game=new Game("demo"),gameLoop()}function gameLoop(){requestAnimFrame(gameLoop),0==game.waitToLoad&&(game.editor.isOn?game.editor.handleInput():game.inputManager.handleInput(),game.scene.update(),game.scene.render(),game.editor.isOn?game.editor.drawUsedObject():game.hud.render())}var vertexBuffer={position:null,textureCoord:null},squareVertexDistance=.5,canvas,GL,mvMatrix=mat4.create(),mvMatrixStack=[],pMatrix=mat4.create(),Vector=function(a,b){this.x=a,this.y=b};Vector.prototype.get=function(){return{x:this.x,y:this.y}},Vector.prototype.setv=function(a){this.x=a.x,this.y=a.y},Vector.prototype.set=function(a,b){this.x=a,this.y=b},Vector.prototype.addv=function(a){this.x+=a.x,this.y+=a.y},Vector.prototype.add=function(a,b){this.x+=a,this.y+=b},Vector.prototype.dot=function(a){return this.x*a.x+this.y*a.y};var shaderProgram,TextureManager=function(){this.currentTexture=null,this.background=[],this.player={idle:[],run:[],jump:[]},this.hud=[],this.ground=[],this.items=[]};TextureManager.prototype.setActiveTexture=function(a){this.currentTexture!=a&&(this.currentTexture=a,GL.bindTexture(GL.TEXTURE_2D,a))},TextureManager.prototype.initTexture=function(a){var b=GL.createTexture();return GL.bindTexture(GL.TEXTURE_2D,b),GL.pixelStorei(GL.UNPACK_FLIP_Y_WEBGL,!0),GL.texImage2D(GL.TEXTURE_2D,0,GL.RGBA,GL.RGBA,GL.UNSIGNED_BYTE,a),GL.texParameteri(GL.TEXTURE_2D,GL.TEXTURE_MAG_FILTER,GL.LINEAR),GL.texParameteri(GL.TEXTURE_2D,GL.TEXTURE_MIN_FILTER,GL.LINEAR),GL.texParameteri(GL.TEXTURE_2D,GL.TEXTURE_WRAP_S,GL.CLAMP_TO_EDGE),GL.texParameteri(GL.TEXTURE_2D,GL.TEXTURE_WRAP_T,GL.CLAMP_TO_EDGE),b},TextureManager.prototype.getSprite=function(a,b){var c=new Image,d=this;c.onload=function(){a.push(d.initTexture(c)),game.finishedLoadingResource()},c.src=b},TextureManager.prototype.getSpriteSheet=function(a,b,c,d,e,f,g,h){var i=new Image,j=this,k=document.createElement("canvas"),l=k.getContext("2d");i.onload=function(){for(var b=c;d>b;++b)for(var m=e;f>m;++m)k.height=h,k.width=g,l.drawImage(i,g*m,h*b,g,h,0,0,g,h),a.push(j.initTexture(k));game.finishedLoadingResource()},i.src=b};var Game=function(a){webGLStart(),this.scene=null,this.inputManager=new Input,this.textureManager=new TextureManager,this.hud=new HUD,this.editor=new Editor,this.waitToLoad=7,this.drawDistance=-7,this.score=0,this.loadTextures(),this.loadScene(a)};Game.prototype.finishedLoadingResource=function(){--this.waitToLoad,this.hud.updateResourceLoading()},Game.prototype.changeScene=function(a){this.hud.clearHUD(),this.waitToLoad=1,this.loadScene(a)},Game.prototype.loadTextures=function(){var a=this.textureManager,b=["grass","snow","desert"],c=b[Math.floor(Math.random()*b.length)];a.getSprite(a.background,"textures/bg/"+c+".png"),a.getSpriteSheet(a.player.idle,"textures/robot.png",0,2,0,5,128,128),a.getSpriteSheet(a.player.run,"textures/robot.png",2,4,0,4,128,128),a.getSpriteSheet(a.player.jump,"textures/robot.png",4,6,0,5,128,128),a.getSpriteSheet(a.hud,"textures/hud.png",0,3,0,5,128,128),a.getSpriteSheet(a.ground,"textures/tiles/"+c+".png",0,3,0,6,128,128)},Game.prototype.loadScene=function(a){var b=this,c=new XMLHttpRequest;c.onreadystatechange=function(){4==c.readyState&&(b.scene=new Scene(JSON.parse(c.responseText)),b.finishedLoadingResource())},c.open("GET","scenes/"+a+".json",!0),c.send()},Game.prototype.uploadScene=function(){var a=new FileReader;a.onload=function(){var b=JSON.parse(a.result);36479732==b.checksum&&(game.scene=new Scene(b))},a.readAsText(document.getElementById("fileSelecter").files[0])},Game.prototype.saveScene=function(a){var b={checksum:36479732,ground:[],decor:[]},c=function(a,b){for(var c=0;c<b.length;++c){var d={pos:{x:b[c].position.x,y:b[c].position.y}};0!=b[c].textureIndex&&(d.texture=b[c].textureIndex),(1!=b[c].scale.x||1!=b[c].scale.y)&&(d.scale={x:b[c].scale.x,y:b[c].scale.y}),a.push(d)}};c(b.ground,this.scene.ground),c(b.decor,this.scene.decor),(0!=this.scene.player.respawnPosition.x||0!=this.scene.player.respawnPosition.y)&&(b.respawn=this.scene.player.respawnPosition);var d=document.createElement("a"),e=new Blob([JSON.stringify(b)],{type:"text/json"});d.href=URL.createObjectURL(e),d.download=a,d.click()},Game.prototype.pause=function(){this.waitToLoad=1-game.waitToLoad,this.scene.lastTime=(new Date).getTime()};var game,Animator=function(a,b){this.attachedTo=a,this.textures=b,this.frameCount=0,this.nextFrame=5};Animator.prototype.animate=function(){var a=this.attachedTo.rigidBody.speed.get(),b=this.textures.idle;Math.abs(a.x)>5e-4&&(b=this.textures.run),Math.abs(a.y)>5e-4&&(b=this.textures.jump),this.attachedTo.texturePool=b,this.attachedTo.textureIndex>=this.attachedTo.texturePool.length&&(this.attachedTo.textureIndex=0),this.frameCount+=1,this.frameCount>this.nextFrame&&(this.frameCount=0,this.attachedTo.textureIndex=(this.attachedTo.textureIndex+1)%this.attachedTo.texturePool.length)};var Editor=function(){this.isOn=!1,this.textureIndex=0,this.switchStopper=!1,this.pools=["GROUND","DECOR"],this.currentPool=0};Editor.prototype.changeOnOff=function(){game.inputManager.clearInput(),this.isOn=!this.isOn,this.isOn?canvas.onmousedown=this.handleMouseDown:canvas.onmousedown=null,game.hud.updateEditor(this.pools[this.currentPool],this.textureIndex+1)},Editor.prototype.drawUsedObject=function(){var a=new GameObject(game.textureManager.ground,this.textureIndex);a.drawDistance=-10,a.position.set(game.scene.camera.x-6.5,game.scene.camera.y+4.5),a.draw()},Editor.prototype.changeTextureIndex=function(a){this.textureIndex+=a,-1==this.textureIndex&&(this.textureIndex+=game.textureManager.ground.length),this.textureIndex==game.textureManager.ground.length&&(this.textureIndex=0),game.hud.updateEditor(this.pools[this.currentPool],this.textureIndex+1)},Editor.prototype.changeObjectPool=function(){this.currentPool=(this.currentPool+1)%this.pools.length,game.hud.updateEditor(this.pools[this.currentPool],this.textureIndex+1)},Editor.prototype.handleMouseDown=function(a){var b={x:Math.round(game.scene.camera.x+(a.pageX-canvas.offsetLeft-canvas.width/2)/75),y:Math.round(game.scene.camera.y+(a.pageY-canvas.offsetTop-canvas.height/2)/-75)},c=null;switch(game.editor.currentPool){case 0:c=game.scene.ground;break;case 1:c=game.scene.decor}switch(a.which){case 1:game.scene.addObjectToScene(c,new GameObject(game.textureManager.ground,game.editor.textureIndex),b,{x:1,y:1});break;case 2:game.scene.removeObjectFromScene(c,game.scene.checkForCoords(c,b))}},Editor.prototype.handleInput=function(){currentlyPressedKeys[39]&&(game.scene.camera.x+=.05),currentlyPressedKeys[37]&&(game.scene.camera.x-=.05),currentlyPressedKeys[83]&&(game.saveScene("newScene.json"),currentlyPressedKeys[83]=!1),currentlyPressedKeys[69]&&(game.editor.changeOnOff(),currentlyPressedKeys[69]=!1),currentlyPressedKeys[70]&&(this.switchStopper||(game.editor.changeTextureIndex(-1),this.switchStopper=!0)),currentlyPressedKeys[71]&&(this.switchStopper||(game.editor.changeTextureIndex(1),this.switchStopper=!0)),currentlyPressedKeys[72]&&(this.switchStopper||(game.editor.changeObjectPool(),this.switchStopper=!0)),currentlyPressedKeys[70]||currentlyPressedKeys[71]||currentlyPressedKeys[72]||(this.switchStopper=!1)};var HUD=function(){this.resourceLoading=document.createTextNode("0"),document.getElementById("resourceLoading").appendChild(this.resourceLoading),this.editor=document.createTextNode("OFF"),document.getElementById("editorMode").appendChild(this.editor),this.textureID=document.createTextNode(""),document.getElementById("textureID").appendChild(this.textureID),this.objects=document.createTextNode("0"),document.getElementById("loadedObjects").appendChild(this.objects)};HUD.prototype.render=function(){var a,b=new GameObject(game.textureManager.hud,13),c=game.scene.camera,d=game.scene.player.maxLives,e=game.scene.player.currentLives,f=game.score,g=function(a){b.position.x=c.x+a,b.draw()};for(b.position.y=c.y+4.5,b.drawDistance=-10,a=0;a<Math.floor(e);++a)g(-6.5+a);for(e-a==.5&&(b.textureIndex=12,g(-6.5+a),++a),b.textureIndex=11;d>a;++a)g(-6.5+a);b.textureIndex=14,g(4.5),b.textureIndex=10,g(5.25),b.textureIndex=Math.floor(f/10)%10,g(6),b.textureIndex=f%10,g(6.5)},HUD.prototype.clearHUD=function(){this.resourceLoading.nodeValue="",this.editor.nodeValue="",this.textureID.nodeValue="",this.objects.nodeValue=""},HUD.prototype.updateEditor=function(a,b){game.editor.isOn?(this.editor.nodeValue="ON",this.textureID.nodeValue=a+": "+b):(this.editor.nodeValue="OFF",this.textureID.nodeValue="")},HUD.prototype.updateLoadedObjects=function(a){this.objects.nodeValue=a},HUD.prototype.updateResourceLoading=function(){var a=6;this.resourceLoading.nodeValue=(100*((a-game.waitToLoad)/a)).toFixed(0)};var currentlyPressedKeys={},Input=function(){this.commands={moveRight:39,moveLeft:37,jump:32,respawn:82,save:83,editor:69},document.onkeydown=this.handleKeyDown,document.onkeyup=this.handleKeyUp};Input.prototype.handleKeyDown=function(a){80==a.keyCode&&game.pause(),currentlyPressedKeys[a.keyCode]=!0},Input.prototype.handleKeyUp=function(a){currentlyPressedKeys[a.keyCode]=!1},Input.prototype.clearInput=function(){for(var a in this.commands)currentlyPressedKeys[this.commands[a]]=!1},Input.prototype.handleInput=function(){currentlyPressedKeys[this.commands.moveRight]||currentlyPressedKeys[this.commands.moveLeft]?currentlyPressedKeys[this.commands.moveRight]?game.scene.player.move("right"):currentlyPressedKeys[this.commands.moveLeft]&&game.scene.player.move("left"):game.scene.player.move("stop"),currentlyPressedKeys[this.commands.jump]&&game.scene.player.jump(),currentlyPressedKeys[this.commands.respawn]&&(game.scene.player.respawn(),game.scene.player.hurt(.5),currentlyPressedKeys[this.commands.respawn]=!1),currentlyPressedKeys[this.commands.save]&&(game.saveScene("newScene.json"),currentlyPressedKeys[this.commands.save]=!1),currentlyPressedKeys[this.commands.editor]&&(confirm("Create new scene?")&&game.changeScene("empty"),game.editor.changeOnOff(),currentlyPressedKeys[this.commands.editor]=!1)};var GameObject=function(a,b){this.tag="StaticObject",this.position=new Vector(0,0),this.drawDistance=game.drawDistance,this.scale=new Vector(1,1),this.texturePool=a,this.textureIndex=b,this.collider=new Collider(this,1,1)};GameObject.prototype.setScale=function(a,b){a>1&&(a=1),b>1&&(b=1),this.scale.set(a,b),this.collider.w=Math.abs(a),this.collider.h=Math.abs(b)},GameObject.prototype.draw=function(){game.textureManager.setActiveTexture(this.texturePool[this.textureIndex]),mvPushMatrix(),mat4.translate(mvMatrix,mvMatrix,[this.position.x,this.position.y,this.drawDistance]),mat4.scale(mvMatrix,mvMatrix,[this.scale.x,this.scale.y,1]),GL.uniformMatrix4fv(shaderProgram.mvMatrixUniform,!1,mvMatrix),GL.drawArrays(GL.TRIANGLE_STRIP,0,4),mvPopMatrix()};var MovableObject=function(a,b,c){GameObject.call(this,a,b),this.tag="DynamicObject",this.rigidBody=new RigidBody(this,c),this.animator=new Animator(this,null)};MovableObject.prototype=Object.create(GameObject.prototype),MovableObject.prototype.constructor=MovableObject,MovableObject.prototype.update=function(){this.rigidBody.applyForce(),this.animator.animate();for(var a=game.scene.ground,b=0;b<a.length;++b)this.position.x-a[b].position.x<=1&&this.position.y-a[b].position.y<=1&&this.onCollision(a[b])},MovableObject.prototype.onCollision=function(a){var b=this.collider.checkForCollision(a.collider);if("NONE"!=b){var c=this.position.get(),d=this.collider,e=a.position.get(),f=a.collider;switch(b){case"UP":this.rigidBody.onGround(),this.position.set(c.x,e.y+(f.h+d.h)/2);break;case"DOWN":this.position.set(c.x,e.y-(f.h+d.h)/2);break;case"RIGHT":this.position.set(e.x+(f.w+d.w)/2,c.y);break;case"LEFT":this.position.set(e.x-(f.w+d.w)/2,c.y)}}};var Player=function(a,b,c){MovableObject.call(this,a,b,c),this.tag="Player",this.animator=new Animator(this,game.textureManager.player),this.respawnPosition=new Vector(0,0),this.currentLives=this.maxLives=3,this.collider.w=.45,this.collider.h=.8};Player.prototype=Object.create(MovableObject.prototype),Player.prototype.constructor=Player,Player.prototype.move=function(a){if("stop"==a)return void(this.rigidBody.speed.x=0);var b=.004;"left"==a?(this.rigidBody.speed.x=-b,this.scale.x=-1):"right"==a&&(this.rigidBody.speed.x=b,this.scale.x=1)},Player.prototype.jump=function(){var a=.015;this.rigidBody.isGrounded&&(this.rigidBody.isGrounded=!1,this.rigidBody.force.y=a)},Player.prototype.hurt=function(a){this.currentLives-=a},Player.prototype.checkForDeath=function(){(this.position.y<-4||this.position.y>5||this.currentLives<=0)&&(this.respawn(),this.currentLives=Math.ceil(.2*this.maxLives))},Player.prototype.respawn=function(){this.position.setv(this.respawnPosition),this.rigidBody.isGrounded=!1,this.rigidBody.resetSpeedAndForce()};var RigidBody=function(a,b){this.attachedTo=a,this.mass=b,this.speed=new Vector(0,0),this.force=new Vector(0,0),this.isGrounded=!1};RigidBody.prototype.applyForce=function(){var a=game.scene.elapsed,b=-1e-5,c=new Vector(this.force.x/this.mass,this.force.y/this.mass);this.force.set(0,0),this.speed.add(c.x*a,(b+c.y)*a);var d=.005;this.speed.y>d&&(this.speed.y=d),this.attachedTo.position.add(this.speed.x*a,this.speed.y*a)},RigidBody.prototype.onGround=function(){this.isGrounded=!0,this.resetSpeedAndForce()},RigidBody.prototype.resetSpeedAndForce=function(){this.speed.set(0,0),this.force.set(0,0)};var Collider=function(a,b,c){this.attachedTo=a,this.w=b,this.h=c};Collider.prototype.checkForCollision=function(a){var b=this.attachedTo.position.get(),c=a.attachedTo.position.get();if(b.x-this.w/2<c.x+a.w/2&&b.x+this.w/2>c.x-a.w/2&&b.y-this.h/2<c.y+a.h/2&&b.y+this.h/2>c.y-a.h/2){var d=b.x-c.x,e=b.y-c.y;return Math.abs(e)>Math.abs(d)?e>0?"UP":"DOWN":d>0?"RIGHT":"LEFT"}return"NONE"};var Scene=function(a){this.camera=new Vector(0,0),this.lastTime=0,this.elapsed=0,this.background=new GameObject(game.textureManager.background,0),this.background.drawDistance=-.5,this.player=new Player(game.textureManager.player.idle,0,50),a.respawn&&this.player.respawnPosition.setv(a.respawn),this.player.respawn();var b=function(a,b,c){for(var d=0;d<c.length;++d){var e={x:1,y:1},f=0;c[d].scale&&(e=c[d].scale),c[d].texture&&(f=c[d].texture),a.addObjectToScene(b,new GameObject(game.textureManager.ground,f),c[d].pos,e)}};this.ground=[],b(this,this.ground,a.ground),this.decor=[],b(this,this.decor,a.decor)};Scene.prototype.addObjectToScene=function(a,b,c,d){a.push(b),a[a.length-1].setScale(d.x,d.y),a[a.length-1].position.setv(c)},Scene.prototype.removeObjectFromScene=function(a,b){b>-1&&b<a.length&&a.splice(b,1)},Scene.prototype.checkForCoords=function(a,b){for(var c=0;c<this.ground.length;++c)if(b.x==a[c].position.x&&b.y==a[c].position.y)return c;return-1},Scene.prototype.prepare=function(a,b,c,d){GL.clear(GL.COLOR_BUFFER_BIT),mat4.perspective(pMatrix,a,b,c,d),GL.uniformMatrix4fv(shaderProgram.pMatrixUniform,!1,pMatrix),mat4.identity(mvMatrix),game.editor.isOn||(this.camera.x=this.player.position.x),this.background.position.x=this.camera.x,mat4.translate(mvMatrix,mvMatrix,[-this.camera.x,-this.camera.y,0])},Scene.prototype.render=function(){this.prepare(45,GL.viewportWidth/GL.viewportHeight,.1,100);var a=0;this.background.draw(),++a;var b=function(b,c){for(var d=0;d<b.length;++d)Math.abs(b[d].position.x-c.x)<6&&(b[d].draw(),++a)};b(this.decor,this.camera),b(this.ground,this.camera),this.player.draw(),++a,game.hud.updateLoadedObjects(a)},Scene.prototype.update=function(){var a=(new Date).getTime();0!=this.lastTime&&(this.elapsed=a-this.lastTime,this.elapsed>60&&(this.elapsed=60),this.player.update()),this.lastTime=a,this.player.checkForDeath()};