function createBufferFromData(a,b,c){var d=GL.createBuffer();return GL.bindBuffer(GL.ARRAY_BUFFER,d),GL.bufferData(GL.ARRAY_BUFFER,new Float32Array(a),GL.STATIC_DRAW),d.itemSize=b,d.numItems=c,d}function initBuffers(){var a=[-squareVertexDistance,squareVertexDistance,0,squareVertexDistance,squareVertexDistance,0,-squareVertexDistance,-squareVertexDistance,0,squareVertexDistance,-squareVertexDistance,0],b=[0,1,1,1,0,0,1,0];return{position:createBufferFromData(a,3,4),textureCoord:createBufferFromData(b,2,4)}}function webGLStart(){canvas=document.getElementById("webgl-context"),GL=initGL(),shaderProgram=initShaders(),vertexBuffer=initBuffers(),GL.clearColor(0,0,0,1),GL.viewport(0,0,GL.viewportWidth,GL.viewportHeight),GL.enable(GL.BLEND),GL.blendFunc(GL.SRC_ALPHA,GL.ONE_MINUS_SRC_ALPHA),GL.bindBuffer(GL.ARRAY_BUFFER,vertexBuffer.position),GL.vertexAttribPointer(shaderProgram.vertexPositionAttribute,vertexBuffer.position.itemSize,GL.FLOAT,!1,0,0),GL.bindBuffer(GL.ARRAY_BUFFER,vertexBuffer.textureCoord),GL.vertexAttribPointer(shaderProgram.textureCoordAttribute,vertexBuffer.textureCoord.itemSize,GL.FLOAT,!1,0,0)}function initGL(){var a;try{a=canvas.getContext("experimental-webgl"),a.viewportWidth=canvas.width,a.viewportHeight=canvas.height}catch(b){}return a?a:(alert("Could not initialise WebGL, sorry :-("),null)}function mvPushMatrix(){var a=mat4.create();mat4.copy(a,mvMatrix),mvMatrixStack.push(a)}function mvPopMatrix(){if(0==mvMatrixStack.length)throw"Invalid popMatrix!";mvMatrix=mvMatrixStack.pop()}function getShader(a,b){var c=document.getElementById(b);if(!c)return null;for(var d="",e=c.firstChild;e;)3==e.nodeType&&(d+=e.textContent),e=e.nextSibling;var f;if("x-shader/x-fragment"==c.type)f=a.createShader(a.FRAGMENT_SHADER);else{if("x-shader/x-vertex"!=c.type)return null;f=a.createShader(a.VERTEX_SHADER)}return a.shaderSource(f,d),a.compileShader(f),a.getShaderParameter(f,a.COMPILE_STATUS)?f:(alert(a.getShaderInfoLog(f)),null)}function initShaders(){var a=getShader(GL,"shader-fs"),b=getShader(GL,"shader-vs"),c=GL.createProgram();return GL.attachShader(c,b),GL.attachShader(c,a),GL.linkProgram(c),GL.getProgramParameter(c,GL.LINK_STATUS)||alert("Could not initialise shaders"),GL.useProgram(c),c.vertexPositionAttribute=GL.getAttribLocation(c,"aVertexPosition"),GL.enableVertexAttribArray(c.vertexPositionAttribute),c.textureCoordAttribute=GL.getAttribLocation(c,"aTextureCoord"),GL.enableVertexAttribArray(c.textureCoordAttribute),c.pMatrixUniform=GL.getUniformLocation(c,"uPMatrix"),c.mvMatrixUniform=GL.getUniformLocation(c,"uMVMatrix"),c.samplerUniform=GL.getUniformLocation(c,"uSampler"),c}function gameLoop(){requestAnimFrame(gameLoop),0==game.waitToLoad&&(game.tick(),game.editor.isOn?game.editor.loop():game.loop())}var vertexBuffer={position:null,textureCoord:null},squareVertexDistance=.5,canvas,GL,mvMatrix=mat4.create(),mvMatrixStack=[],pMatrix=mat4.create(),Vector=function(a,b){this.x=a,this.y=b};Vector.prototype={get:function(){return{x:this.x,y:this.y}},setv:function(a){this.x=a.x,this.y=a.y},set:function(a,b){this.x=a,this.y=b},addv:function(a){this.x+=a.x,this.y+=a.y},add:function(a,b){this.x+=a,this.y+=b},dot:function(a){return this.x*a.x+this.y*a.y}};var shaderProgram,TextureManager=function(){this.currentTexture=null};TextureManager.prototype={setActiveTexture:function(a){this.currentTexture!=a&&(this.currentTexture=a,GL.bindTexture(GL.TEXTURE_2D,a))},initTexture:function(a){var b=GL.createTexture();return GL.bindTexture(GL.TEXTURE_2D,b),GL.pixelStorei(GL.UNPACK_FLIP_Y_WEBGL,!0),GL.texImage2D(GL.TEXTURE_2D,0,GL.RGBA,GL.RGBA,GL.UNSIGNED_BYTE,a),GL.texParameteri(GL.TEXTURE_2D,GL.TEXTURE_MAG_FILTER,GL.LINEAR),GL.texParameteri(GL.TEXTURE_2D,GL.TEXTURE_MIN_FILTER,GL.LINEAR),GL.texParameteri(GL.TEXTURE_2D,GL.TEXTURE_WRAP_S,GL.CLAMP_TO_EDGE),GL.texParameteri(GL.TEXTURE_2D,GL.TEXTURE_WRAP_T,GL.CLAMP_TO_EDGE),b},getSprite:function(a,b){game.waitToLoad++;var c=new Image,d=this;c.onload=function(){a.push(d.initTexture(c)),game.waitToLoad--},c.src=b},getSpriteSheet:function(a,b,c,d,e,f,g,h){game.waitToLoad++;var i=new Image,j=this,k=document.createElement("canvas"),l=k.getContext("2d");i.onload=function(){for(var b=c;d>b;++b)for(var m=e;f>m;++m)k.height=h,k.width=g,l.drawImage(i,g*m,h*b,g,h,0,0,g,h),a.push(j.initTexture(k));game.waitToLoad--},i.src=b},getColor:function(a){var b=GL.createTexture();GL.bindTexture(GL.TEXTURE_2D,b),GL.texImage2D(GL.TEXTURE_2D,0,GL.RGBA,1,1,0,GL.RGBA,GL.UNSIGNED_BYTE,new Uint8Array(a)),GL.bindTexture(GL.TEXTURE_2D,null),this.colors.push(b)}};var Animator=function(a){this.frameCount=0,this.nextFrame=a};Animator.prototype={animate:function(a,b){a.textureIndex>=b.length&&(a.textureIndex=0),a.texturePool=b,this.frameCount+=1,this.frameCount>this.nextFrame&&(this.frameCount=0,a.textureIndex=(a.textureIndex+1)%b.length)}};var Camera=function(){this.position=new Vector(0,0),this.range=new Vector(9,5),this.background=new GameObject(game.textureManager.background,0),this.background.drawDistance=-.5,this.background.scale.x=1.19,this.background.position=this.position};Camera.prototype={followPlayer:function(){this.position.x=Math.max(4,game.player.position.x),this.position.y=Math.max(0,game.player.position.y-2)},prepareScene:function(){GL.clear(GL.COLOR_BUFFER_BIT),mat4.perspective(pMatrix,45,GL.viewportWidth/GL.viewportHeight,.1,100),GL.uniformMatrix4fv(shaderProgram.pMatrixUniform,!1,pMatrix),mat4.identity(mvMatrix),mat4.translate(mvMatrix,mvMatrix,[-this.position.x,-this.position.y,0]),this.background.render()},inRange:function(a,b){return Math.abs(a.position.x-this.position.x)<b*this.range.x&&Math.abs(a.position.y-this.position.y)<b*this.range.y}};var Collider=function(a,b,c){this.attachedTo=a,this.offset=new Vector(0,0),this.w=b,this.h=c};Collider.prototype={render:function(){var a=this.center();game.textureManager.setActiveTexture(game.textureManager.colors[2]),mvPushMatrix(),mat4.translate(mvMatrix,mvMatrix,[a.x,a.y,this.attachedTo.drawDistance]),mat4.scale(mvMatrix,mvMatrix,[this.w,this.h,1]),GL.uniformMatrix4fv(shaderProgram.mvMatrixUniform,!1,mvMatrix),GL.drawArrays(GL.TRIANGLE_STRIP,0,4),mvPopMatrix()},center:function(){var a=this.attachedTo.position.get();return new Vector(a.x+this.offset.x,a.y+this.offset.y)},checkForCollision:function(a){var b=this.center(),c=a.center(),d=new Vector(c.x+a.w/2,c.y+a.h/2),e=new Vector(c.x-a.w/2,c.y-a.h/2);if(b.x-this.w/2<d.x&&b.x+this.w/2>e.x&&b.y-this.h/2<d.y&&b.y+this.h/2>e.y){var f=b.y>=e.y&&b.y<=d.y,g=b.x>=e.x&&b.x<=d.x;if(b.x>d.x&&f)return"RIGHT";if(b.x<e.x&&f)return"LEFT";if(b.y>d.y&&g)return"UP";if(b.y<e.y&&g)return"DOWN"}return"NONE"}};var Editor=function(){this.isOn=this.selectOn=!1,this.decorFlag=this.deleteFlag=!1,this.usedObj=new GameObject(game.textureManager.ground,0),this.allObj=[]};Editor.prototype={initEditor:function(){for(;game.scene.removed.length>0;){var a=game.scene.removed.pop();Factory({pos:a.position,tag:a.tag,texture:a.textureIndex})}if(0==this.allObj.length)for(var b in Creator)this.allObj=this.allObj.concat(Creator[b].editor())},loop:function(){this.handleInput(),game.scene.render(),this.selectOn&&this.drawObjectSelection(),this.drawUsedObject()},changeMode:function(){if(game.hud.menu("mainMenu"),game.inputManager.clearInput(),this.isOn=!this.isOn,this.isOn)canvas.onmousedown=this.putNewBlock,this.initEditor();else{var a=game.player;a.respawn(),a.currentLives=a.maxLives=3,game.score=0,this.selectOn=this.decorFlag=!1,canvas.onmousedown=null}},drawUsedObject:function(){if(!this.selectOn){var a=new GameObject(game.textureManager.colors,0);this.decorFlag&&(a.textureIndex=1),this.deleteFlag&&(a.textureIndex=3),a.drawDistance=-10,a.scale=new Vector(1.5,1.5),a.position.setv(game.scene.camera.position),a.position.add(11,-4.75),a.render()}this.usedObj.drawDistance=-10,this.usedObj.position.setv(game.scene.camera.position),this.usedObj.position.add(11,-4.75),this.usedObj.render()},drawObjectSelection:function(){var a=new GameObject(game.textureManager.colors,0);this.decorFlag&&(a.textureIndex=1),this.deleteFlag&&(a.textureIndex=3),a.drawDistance=-.1,a.position.setv(game.scene.camera.position),a.render();for(var b=0;b<Math.ceil(this.allObj.length/9);++b)for(var c=0;9>c;++c){var d=9*b+c;if(d==this.allObj.length)return;var e=this.allObj[d];e.drawDistance=-7,e.position.setv(game.scene.camera.position),e.position.add(c-4,3-b),e.scale.set(.8,.8),e.render()}},putNewBlock:function(a){var b=game.editor.usedObj.tag,c=game.scene.camera.position,d=75,e={x:Math.round(c.x+(a.pageX-canvas.offsetLeft-canvas.width/2)/d),y:Math.round(c.y+(a.pageY-canvas.offsetTop-canvas.height/2)/-d)};game.editor.decorFlag&&"GameObject"==b&&(b="DecorObject"),1==a.which&&(game.editor.deleteFlag?game.editor.deleteBlock(e):Factory({pos:e,tag:b,texture:game.editor.usedObj.textureIndex}))},selectNewBlock:function(a){var b={x:4+Math.round((a.pageX-canvas.offsetLeft-canvas.width/2)/75),y:3-Math.round((a.pageY-canvas.offsetTop-canvas.height/2)/-75)};if(1==a.which){var c=9*b.y+b.x;if(c>game.editor.allObj.length||0>c)return;game.editor.usedObj=game.editor.allObj[c]}},deleteBlock:function(a){var b=[],c=game.scene;b.push(c.ground,c.decor,c.pickups,c.enemies,c.environment);for(var d=0;d<b.length;++d)for(var e=0;e<b[d].length;++e)Math.abs(a.x-b[d][e].position.x)<.5&&Math.abs(a.y-b[d][e].position.y)<.5&&b[d].splice(e,1)},toggleSelector:function(a){this.selectOn=a,this.selectOn?canvas.onmousedown=this.selectNewBlock:canvas.onmousedown=this.putNewBlock},handleInput:function(){currentlyPressedKeys[39]&&(game.scene.camera.position.x+=.05),currentlyPressedKeys[37]&&(game.scene.camera.position.x-=.05),currentlyPressedKeys[38]&&(game.scene.camera.position.y+=.05),currentlyPressedKeys[40]&&(game.scene.camera.position.y-=.05),this.toggleSelector(currentlyPressedKeys[81]),this.decorFlag=currentlyPressedKeys[87],this.deleteFlag=currentlyPressedKeys[69]}};var Creator={},Factory=function(a){var b=a.tag;b in Creator||(b="GameObject");var c=Creator[b].create(a);c.position.setv(a.pos),Creator[b].pool().push(c)},HUD=function(){this.menus=[],this.fps={node:document.createTextNode("0"),counter:0,visible:!1,toggle:function(){this.visible=!this.visible,this.visible?document.getElementById("fpsMenu").style.visibility="visible":document.getElementById("fpsMenu").style.visibility="hidden"}},document.getElementById("fps").appendChild(this.fps.node)};HUD.prototype={init:function(a){switch(a){case"death":return"<p>Too bad, you died!<br/>Your score: "+game.score+"</p><button onclick='game.hud.closeMenu();'>TRY AGAIN</button>";case"victory":return"<p>Great job!<br/>Your score: "+game.score+"</p><button onclick='game.hud.closeMenu();'>NEXT LEVEL</button>";case"scene":return"<h1>SCENE MANAGEMENT</h1><hr/><p onclick='game.saveScene();'>DOWNLOAD SCENE</p><p onclick='game.uploadScene();'>UPLOAD SCENE</p><p onclick='game.hud.closeMenu();'>BACK</p>";case"editorIntro":return game.editor.isOn?"<h1>EDITOR</h1><hr/><p onclick='game.editor.changeMode();'>PLAY SCENE</p><p>OBJECT SELECTION (Q / GRAY)<br/>DECOR MODE (W / BLUE)<br/>DELETE MODE (E / RED)</p><p onclick='game.hud.closeMenu();'>BACK</p>":"<h1>EDITOR</h1><hr/><p onclick='game.editor.changeMode(); game.loadScene(\"empty\");'>CREATE NEW SCENE</p><p onclick='game.editor.changeMode();'>EDIT CURRENT SCENE</p><p onclick='game.hud.closeMenu();'>BACK</p>";case"customization":return'<h1>CUSTOMIZATION</h1><hr/><p onclick=\'game.hud.hideInfo("customization"); game.hud.info("player", 500, 150);\'>PLAYER</p><p onclick=\'game.hud.hideInfo("customization"); game.hud.info("biome", 500, 150);\'>BIOME</p><p onclick=\'document.getElementById("startMenu").style.visibility = "visible"; game.hud.hideInfo("customization");\'>BACK</p>';case"player":return'<h1>CHOOSE PLAYER</h1><hr/><p onclick=\'game.loadPlayerTextures("robot");\'>ROBOT</p><p onclick=\'game.loadPlayerTextures("adventurer");\'>ADVENTURER</p> <p onclick=\'game.hud.hideInfo("player"); game.hud.info("customization", 500, 150);\'>BACK</p>';case"biome":return'<h1>CHOOSE BIOME</h1><hr/><p onclick=\'game.loadBiomeTextures("grass");\'>GRASS</p><p onclick=\'game.loadBiomeTextures("snow");\'>SNOW</p> <p onclick=\'game.loadBiomeTextures("desert");\'>DESERT</p> <p onclick=\'game.hud.hideInfo("biome"); game.hud.info("customization", 500, 150);\'>BACK</p>';case"debug":return"<h1>DEBUG OPTIONS</h1><hr/><p onclick='game.hud.fps.toggle();'>TOGGLE FPS</p><p onclick='game.player.toggleCollider();'>PLAYER COLLIDER</p><p onclick='game.scene.togglePoolCollider(game.scene.ground);'>GROUND COLLIDERS</p><p onclick='game.scene.togglePoolCollider(game.scene.enemies);'>ENEMY COLLIDERS</p><p onclick='game.scene.togglePoolCollider(game.scene.environment);'>ENVIRONMENT COLLIDERS</p><p onclick='game.scene.togglePoolCollider(game.scene.pickups);'>PICKUP COLLIDERS</p><p onclick='game.hud.closeMenu();'>BACK</p>";default:return""}},render:function(){var a,b=new GameObject(game.textureManager.hud,13),c=game.scene.camera.position,d=game.player.maxLives,e=game.player.currentLives,f=game.score,g=10.5,h=function(a){b.position.x=c.x+a,b.render()};for(b.position.y=c.y+4.5,b.drawDistance=-10,a=0;a<Math.floor(e);++a)h(a-g);for(e-a==.5&&(b.textureIndex=12,h(a-g),++a),b.textureIndex=11;d>a;++a)h(a-g);b.textureIndex=14,h(g-2),b.textureIndex=10,h(g-1.25),b.textureIndex=Math.floor(f/10)%10,h(g-.5),b.textureIndex=f%10,h(g)},menu:function(a){if(0==this.menus.length)this.showMenu(a);else for(;this.menus.length>0;)this.closeMenu()},showMenu:function(a){var b=this.menus.length;if(0==b)game.pause();else{var c=this.menus.pop();document.getElementById(c).style.visibility="hidden",this.menus.push(c)}document.getElementById(a).style.visibility="visible",this.menus.push(a)},closeMenu:function(){var a;this.menus.length>0&&(a=this.menus.pop(),document.getElementById(a).style.visibility="hidden"),this.menus.length>0?(a=this.menus.pop(),document.getElementById(a).style.visibility="visible",this.menus.push(a)):game.pause()},createMenu:function(a){var b=document.createElement("DIV");return b.className="menu",b.id=a,b.innerHTML=this.init(a),b},menuContent:function(a){var b=this.createMenu(a);if(""!=b.innerHTML){var c=document.getElementById("container");c.replaceChild(b,c.childNodes[2]),this.showMenu(a)}},info:function(a,b,c){var d=this.createMenu(a);if(""!=d.innerHTML){d.style.visibility="visible",d.style.left=b,d.style.top=c;var e=document.getElementById("container");e.replaceChild(d,e.childNodes[4])}},hideInfo:function(a){document.getElementById(a).style.visibility="hidden"},updateFPS:function(a){this.fps.counter+=a,this.fps.counter>=50&&(this.fps.node.nodeValue=(1e3/a).toFixed(0),this.fps.counter=0)}};var currentlyPressedKeys={},Input=function(){this.commands={moveRight:39,moveLeft:37,jump:32},document.onkeydown=this.handleKeyDown,document.onkeyup=this.handleKeyUp};Input.prototype={handleKeyDown:function(a){27==a.keyCode&&game.hud.menu("mainMenu"),currentlyPressedKeys[a.keyCode]=!0},handleKeyUp:function(a){currentlyPressedKeys[a.keyCode]=!1},clearInput:function(){for(var a in this.commands)currentlyPressedKeys[this.commands[a]]=!1},handleInput:function(){currentlyPressedKeys[this.commands.moveRight]||currentlyPressedKeys[this.commands.moveLeft]?currentlyPressedKeys[this.commands.moveRight]?game.player.move("RIGHT"):currentlyPressedKeys[this.commands.moveLeft]&&game.player.move("LEFT"):game.player.move("STOP"),currentlyPressedKeys[this.commands.jump]&&(game.player.jump(),currentlyPressedKeys[this.commands.jump]=!1)}};var Scene=function(){this.camera=new Camera};Scene.prototype={init:function(a){if(a){this.ground=[],this.decor=[],this.pickups=[],this.environment=[],this.enemies=[],this.removed=[];for(var b=0;b<a.length;++b)Factory(a[b]);game.player.respawnPosition.set(0,0),game.player.respawn()}},removeObject:function(a){var b=Creator[a.tag].pool();game.scene.removed.push(a),b.splice(b.indexOf(a),1)},drawPool:function(a){for(var b=0;b<a.length;++b)this.camera.inRange(a[b],1)&&a[b].render()},updatePool:function(a){for(var b=0;b<a.length;++b)this.camera.inRange(a[b],1.5)&&a[b].update()},togglePoolCollider:function(a){for(var b=0;b<a.length;++b)a[b].debug=!a[b].debug;this.render(),game.player.render(),game.hud.render()},render:function(){this.camera.prepareScene(),this.drawPool(this.decor),this.drawPool(this.ground),this.drawPool(this.pickups),this.drawPool(this.environment),this.drawPool(this.enemies)},update:function(){this.updatePool(this.enemies),this.updatePool(this.environment)}};var GameObject=function(a,b){this.tag="GameObject",this.position=new Vector(0,0),this.drawDistance=game.drawDistance,this.scale=new Vector(1,1),this.texturePool=a,this.textureIndex=b,this.collider=new Collider(this,1,1),this.debug=!1};GameObject.prototype={render:function(){game.textureManager.setActiveTexture(this.texturePool[this.textureIndex]),mvPushMatrix(),mat4.translate(mvMatrix,mvMatrix,[this.position.x,this.position.y,this.drawDistance]),mat4.scale(mvMatrix,mvMatrix,[this.scale.x,this.scale.y,1]),GL.uniformMatrix4fv(shaderProgram.mvMatrixUniform,!1,mvMatrix),GL.drawArrays(GL.TRIANGLE_STRIP,0,4),mvPopMatrix(),this.debug&&this.collider.render()},setScale:function(a,b){a>1&&(a=1),b>1&&(b=1),this.scale.set(a,b),this.collider.w=Math.abs(a),this.collider.h=Math.abs(b)},writeData:function(){var a={pos:{x:this.position.x,y:this.position.y}};return a.texture=this.textureIndex,"GameObject"!=this.tag&&(a.tag=this.tag),a}},Creator.GameObject={create:function(a){return new GameObject(game.textureManager.ground,a.texture)},pool:function(){return game.scene.ground},editor:function(){for(var a=[],b=0;16>b;++b)a.push(new GameObject(game.textureManager.ground,b));return a}},Creator.DecorObject={create:function(a){var b=new GameObject(game.textureManager.ground,a.texture);return b.tag="DecorObject",b},pool:function(){return game.scene.decor},editor:function(){for(var a=[],b=16;23>b;++b){var c=new GameObject(game.textureManager.ground,b);c.tag="DecorObject",a.push(c)}return a}};var RigidBody=function(a,b){GameObject.call(this,a,b),this.tag="RigidBody",this.speed=new Vector(0,0),this.onGround=!1};RigidBody.prototype=Object.assign(Object.create(GameObject.prototype),{constructor:RigidBody,update:function(){this.applyPhysics(),this.checkForCollisionWith(game.scene.ground)},applyPhysics:function(){var a=game.elapsed/1e3,b=-9.81;this.speed.y+=b*a,this.position.add(this.speed.x*a,this.speed.y*a)},grounded:function(){this.onGround=!0,this.speed.y=0},checkForCollisionWith:function(a){for(var b=0;b<a.length;++b)if(Math.abs(this.position.x-a[b].position.x)<=1&&Math.abs(this.position.y-a[b].position.y)<=1){var c=this.collider.checkForCollision(a[b].collider);if("NONE"==c)continue;this.onCollision(a[b],c)}},onCollision:function(a,b){var c=this.collider,d=a.collider.center(),e=a.collider;switch(b){case"UP":this.grounded(),this.position.y=d.y+(e.h+c.h)/2-c.offset.y;break;case"DOWN":this.speed.y=0,this.position.y=d.y-(e.h+c.h)/2-c.offset.y;break;case"RIGHT":this.position.x=d.x+(e.w+c.w)/2-c.offset.x;break;case"LEFT":this.position.x=d.x-(e.w+c.w)/2-c.offset.x}}});var Enemy=function(a,b,c){RigidBody.call(this,a,b),this.tag="Enemy",this.spawn=c};Enemy.prototype=Object.assign(Object.create(RigidBody.prototype),{constructor:Enemy,writeData:function(){var a=GameObject.prototype.writeData.call(this);return a.pos.x=this.spawn.x,a.pos.y=this.spawn.y,a},interact:function(a,b){},kill:function(){this.position=this.spawn,game.scene.removeObject(this)}});var SlimeEnemy=function(a){Enemy.call(this,game.textureManager.enemy.slime,0,a),this.tag="SlimeEnemy",this.animator=new Animator(20),this.speed.x=-2,this.collider.offset.y=-.25,this.collider.h=.5,this.collider.w=.8,this.killed=!1};SlimeEnemy.prototype=Object.assign(Object.create(Enemy.prototype),{constructor:SlimeEnemy,update:function(){RigidBody.prototype.update.call(this),this.killed||(this.checkForCollisionWith(game.scene.enemies),this.animator.animate(this,game.textureManager.enemy.slime.slice(0,2))),this.position.y<-4&&Enemy.prototype.kill.call(this)},changeDirection:function(){this.position.y+=.25,this.speed.x*=-1,this.scale.x*=-1},onCollision:function(a,b){("LEFT"==b||"RIGHT"==b)&&this.changeDirection(),RigidBody.prototype.onCollision.call(this,a,b)},kill:function(){this.killed=!0,this.speed.x=0,this.texturePool=game.textureManager.enemy.slime,this.textureIndex=2,this.collider.offset.y=-.4,this.collider.h=.2},interact:function(a,b){"UP"==b?(this.kill(),a.bounce(7.5)):this.killed||(a.immunityPeriod<=0&&this.changeDirection(),a.hurt(.5))}});var SawEnemy=function(a){Enemy.call(this,game.textureManager.enemy.saw,0,a),this.tag="SawEnemy",this.animator=new Animator(20),this.speed.x=-3.5,this.collider.offset.y=-.25,this.collider.h=.5};SawEnemy.prototype=Object.assign(Object.create(Enemy.prototype),{constructor:SawEnemy,update:function(){RigidBody.prototype.update.call(this),this.animator.animate(this,game.textureManager.enemy.saw.slice(0,2)),this.speed.y<0&&this.changeDirection(),this.position.y<-4&&Enemy.prototype.kill.call(this)},changeDirection:function(){this.speed.x*=-1,this.speed.y=0},onCollision:function(a,b){("LEFT"==b||"RIGHT"==b)&&this.changeDirection(),RigidBody.prototype.onCollision.call(this,a,b)},interact:function(a,b){a.hurt(.5),"UP"==b&&a.bounce(3)}});var GhostEnemy=function(a){Enemy.call(this,game.textureManager.enemy.ghost,0,a),this.tag="GhostEnemy",this.animator=new Animator(100),this.step=0,this.collider.w=.5,this.collider.h=.65,this.path=new Vector(Math.max(1,3*Math.random()),Math.max(1,3*Math.random()))};GhostEnemy.prototype=Object.assign(Object.create(Enemy.prototype),{constructor:GhostEnemy,update:function(){this.position.x=this.spawn.x+this.path.x*Math.cos(this.step/60),this.position.y=this.spawn.y+this.path.y*Math.sin(2*this.step/60),this.step++,this.animator.animate(this,game.textureManager.enemy.ghost.slice(0,2))},interact:function(a,b){a.hurt(.5)}});var FishEnemy=function(a){Enemy.call(this,game.textureManager.enemy.fish,0,a),this.tag="FishEnemy",this.collider.w=.6,this.collider.h=.65,this.nextJump=0};FishEnemy.prototype=Object.assign(Object.create(Enemy.prototype),{constructor:FishEnemy,update:function(){this.position.y<-5&&(this.speed.y=12,this.position.y=-4.9,this.nextJump=1500,this.textureIndex=0),this.nextJump<=0&&this.applyPhysics(),2!=this.textureIndex&&(this.speed.y<0?this.textureIndex=1:this.textureIndex=0),this.nextJump-=game.elapsed},interact:function(a,b){"UP"==b?this.speed.y>0&&(a.bounce(3),this.speed.y=0,this.textureIndex=2):a.hurt(.5)}}),Creator.SlimeEnemy={create:function(a){return new SlimeEnemy(a.pos)},pool:function(){return game.scene.enemies},editor:function(){return new SlimeEnemy}},Creator.SawEnemy={create:function(a){return new SawEnemy(a.pos)},pool:function(){return game.scene.enemies},editor:function(){return new SawEnemy}},Creator.GhostEnemy={create:function(a){return new GhostEnemy(a.pos)},pool:function(){return game.scene.enemies},editor:function(){return new GhostEnemy}},Creator.FishEnemy={create:function(a){return new FishEnemy(a.pos)},pool:function(){return game.scene.enemies},editor:function(){return new FishEnemy}};var EnvironmentObject=function(a,b){RigidBody.call(this,a,b),this.tag="Environment"};EnvironmentObject.prototype=Object.assign(Object.create(RigidBody.prototype),{constructor:EnvironmentObject,interact:function(a,b){}});var SpikesObject=function(){EnvironmentObject.call(this,game.textureManager.items,8),this.tag="Spikes",this.collider.offset.y=-.25,this.collider.h=.5};SpikesObject.prototype=Object.assign(Object.create(EnvironmentObject.prototype),{constructor:SpikesObject,update:function(){},interact:function(a,b){"UP"==b&&a.speed.y<0&&a.hurt(1)}});var CheckpointObject=function(){EnvironmentObject.call(this,game.textureManager.items,4),this.tag="Checkpoint",this.animator=new Animator(30),this.used=!1};CheckpointObject.prototype=Object.assign(Object.create(EnvironmentObject.prototype),{constructor:CheckpointObject,update:function(){this.used&&this.animator.animate(this,game.textureManager.items.slice(5,7))},interact:function(a,b){this.used||(a.respawnPosition=this.position,this.used=!0)}});var BridgeObject=function(a){EnvironmentObject.call(this,game.textureManager.items,9),this.tag="Bridge",this.steppedOn=!1,this.countdown=500,this.spawn=a};BridgeObject.prototype=Object.assign(Object.create(EnvironmentObject.prototype),{constructor:BridgeObject,update:function(){this.steppedOn&&(this.countdown-=game.elapsed),this.countdown<=0&&this.applyPhysics(),this.position.y<-5&&(this.position.setv(this.spawn),game.scene.removeObject(this))},interact:function(a,b){"UP"==b&&(RigidBody.prototype.onCollision.call(a,this,"UP"),this.steppedOn=!0)},writeData:function(){var a=GameObject.prototype.writeData.call(this);return a.pos.x=this.spawn.x,a.pos.y=this.spawn.y,a}});var BoxObject=function(a){EnvironmentObject.call(this,game.textureManager.items,10),this.tag="Box",this.collider.h=this.collider.w=.65,this.collider.offset.y=-.2};BoxObject.prototype=Object.assign(Object.create(EnvironmentObject.prototype),{constructor:BoxObject,update:function(){},interact:function(a,b){if(RigidBody.prototype.onCollision.call(a,this,b),"DOWN"==b){game.scene.removeObject(this);var c=Math.random();Factory(.4>c?{pos:this.position,tag:"CoinPickUp",texture:1}:.7>c?{pos:this.position,tag:"HeartPickUp"}:.95>c?{pos:this.position,tag:"GhostEnemy"}:{pos:this.position,tag:"CoinPickUp",texture:3})}}}),Creator.Spikes={create:function(a){return new SpikesObject},pool:function(){return game.scene.environment},editor:function(){return new SpikesObject}},Creator.Checkpoint={create:function(a){return new CheckpointObject},pool:function(){return game.scene.environment},editor:function(){return new CheckpointObject}},Creator.Bridge={create:function(a){return new BridgeObject(a.pos)},pool:function(){return game.scene.enemies},editor:function(){return new BridgeObject}},Creator.Box={create:function(a){return new BoxObject},pool:function(){return game.scene.ground},editor:function(){return new BoxObject}};var PickUpObject=function(a,b){GameObject.call(this,a,b),this.tag="PickUp",this.setScale(.75,.75)};PickUpObject.prototype=Object.assign(Object.create(GameObject.prototype),{constructor:PickUpObject,interact:function(a,b){game.scene.removeObject(this)}});var CoinPickUpObject=function(a){var b=1;1==a?b=2:2==a?b=5:3==a&&(b=15),PickUpObject.call(this,game.textureManager.items,a),this.tag="CoinPickUp",this.value=b};CoinPickUpObject.prototype=Object.assign(Object.create(PickUpObject.prototype),{constructor:CoinPickUpObject,interact:function(a,b){PickUpObject.prototype.interact.call(this,a,b);var c=Math.floor(game.score/10)%10;game.score+=this.value;var d=Math.floor(game.score/10)%10;9==c&&0==d&&game.player.maxLives<=8&&(game.player.maxLives++,game.player.heal(1))}});var StarPickUpObject=function(){PickUpObject.call(this,game.textureManager.items,7),this.tag="StarPickUp"};StarPickUpObject.prototype=Object.assign(Object.create(PickUpObject.prototype),{constructor:StarPickUpObject,interact:function(a,b){PickUpObject.prototype.interact.call(this,a,b),game.hud.menuContent("victory"),game.nextLevel()}});var HeartPickUpObject=function(){PickUpObject.call(this,game.textureManager.items,11),this.tag="HeartPickUp"};HeartPickUpObject.prototype=Object.assign(Object.create(PickUpObject.prototype),{constructor:HeartPickUpObject,interact:function(a,b){a.currentLives<a.maxLives&&(PickUpObject.prototype.interact.call(this,a,b),a.heal(1))}}),Creator.CoinPickUp={create:function(a){return new CoinPickUpObject(a.texture)},pool:function(){return game.scene.pickups},editor:function(){for(var a=[],b=0;4>b;++b)a.push(new CoinPickUpObject(b));return a}},Creator.HeartPickUp={create:function(a){return new HeartPickUpObject},pool:function(){return game.scene.pickups},editor:function(){return new HeartPickUpObject}},Creator.StarPickUp={create:function(a){return new StarPickUpObject},pool:function(){return game.scene.pickups},editor:function(){return new StarPickUpObject}};var Player=function(){RigidBody.call(this,game.textureManager.player,0),this.tag="Player",this.animator=new Animator(5),this.respawnPosition=new Vector(0,0),this.currentLives=this.maxLives=3,this.immunityPeriod=0,this.collider.w=.5,this.collider.h=.8,this.doubleJumpReady=!0};Player.prototype=Object.assign(Object.create(RigidBody.prototype),{constructor:Player,update:function(){RigidBody.prototype.update.call(this),this.checkForCollisionWith(game.scene.pickups),this.checkForCollisionWith(game.scene.environment),this.checkForCollisionWith(game.scene.enemies),this.immunityPeriod>0&&(this.immunityPeriod-=game.elapsed),this.checkForDeath(),this.animate()},move:function(a){if("STOP"==a)return void(this.speed.x=0);var b=4;"LEFT"==a?(this.speed.x=-b,this.scale.x=-1):"RIGHT"==a&&(this.speed.x=b,this.scale.x=1)},jump:function(){var a=5;this.onGround?(this.onGround=!1,this.speed.y=a):this.doubleJumpReady&&(this.doubleJumpReady=!1,this.speed.y=a)},animate:function(){var a=this.speed.get(),b=game.textureManager.player.slice(0,10);Math.abs(a.x)>.5&&(b=game.textureManager.player.slice(10,18)),Math.abs(a.y)>.5&&(b=game.textureManager.player.slice(20,30)),this.animator.animate(this,b)},hurt:function(a){this.immunityPeriod<=0&&(this.currentLives-=a,this.immunityPeriod=1e3)},bounce:function(a){this.grounded(),this.doubleJumpReady=!1,this.speed.y=a},heal:function(a){this.currentLives=Math.min(this.maxLives,this.currentLives+a)},checkForDeath:function(){this.position.y<-4&&(this.respawn(),this.hurt(1)),this.currentLives<=0&&(game.hud.menuContent("death"),game.score=0,this.currentLives=this.maxLives=3,game.loadScene(game.currentLevel+""))},respawn:function(){game.inputManager.clearInput(),this.position.setv(this.respawnPosition),this.onGround=!1,this.speed=new Vector(0,0)},onCollision:function(a,b){return a instanceof PickUpObject||a instanceof EnvironmentObject||a instanceof Enemy?void a.interact(this,b):(RigidBody.prototype.onCollision.call(this,a,b),void("UP"==b&&(this.doubleJumpReady=!0)))},toggleCollider:function(){this.debug=!this.debug,game.scene.render(),this.render(),game.hud.render()}});var game,Game=function(){webGLStart(),this.textureManager=new TextureManager,this.hud=new HUD,this.waitToLoad=0,this.drawDistance=-7,this.score=0,this.currentLevel=0,this.numberOfLevels=3,this.lastTime=0,this.elapsed=0};Game.prototype={start:function(){document.getElementById("startMenu").style.visibility="hidden",this.scene=new Scene,this.inputManager=new Input,this.editor=new Editor,this.player=new Player,this.loadScene("0"),gameLoop()},tick:function(){var a=(new Date).getTime();0!=this.lastTime&&(this.elapsed=a-this.lastTime,this.hud.updateFPS(this.elapsed),this.elapsed>30&&(this.elapsed=30)),this.lastTime=a},loop:function(){this.inputManager.handleInput(),this.player.update(),this.scene.update(),this.scene.camera.followPlayer(),this.scene.render(),this.player.render(),this.hud.render()},nextLevel:function(){this.currentLevel=(this.currentLevel+1)%this.numberOfLevels,this.loadScene(this.currentLevel+"")},loadTextures:function(){this.loadPlayerTextures("robot"),this.loadBiomeTextures("grass"),this.loadEnemyTextures(),this.loadOtherTextures()},loadBiomeTextures:function(a){var b=this.textureManager;b.background=[],b.ground=[],b.getSprite(b.background,"textures/bg/"+a+".png"),b.getSpriteSheet(b.ground,"textures/tiles/"+a+".png",0,6,0,4,128,128)},loadPlayerTextures:function(a){var b=this.textureManager;b.player=[],b.getSpriteSheet(b.player,"textures/players/"+a+".png",0,6,0,5,128,128)},loadEnemyTextures:function(){var a=this.textureManager;a.enemy={slime:[],ghost:[],fish:[],saw:[]},a.getSpriteSheet(a.enemy.slime,"textures/enemies.png",0,1,2,5,128,128),a.getSpriteSheet(a.enemy.ghost,"textures/enemies.png",1,2,0,2,128,128),a.getSpriteSheet(a.enemy.fish,"textures/enemies.png",1,2,2,5,128,128),a.getSpriteSheet(a.enemy.saw,"textures/enemies.png",0,1,0,2,128,128)},loadOtherTextures:function(){var a=this.textureManager;a.hud=[],a.items=[],a.colors=[],a.getSpriteSheet(a.hud,"textures/hud.png",0,3,0,5,128,128),a.getSpriteSheet(a.items,"textures/items.png",0,5,0,4,128,128),
a.getColor([0,0,0,200]),a.getColor([0,0,50,200]),a.getColor([0,100,0,175]),a.getColor([50,0,0,200])},loadScene:function(a){game.waitToLoad++;var b=new XMLHttpRequest;b.onreadystatechange=function(){if(4==b.readyState){var a=JSON.parse(b.responseText);36479732==a.checksum&&(game.scene.init(a.sceneInfo),game.waitToLoad--)}},b.open("GET","scenes/"+a+".json",!0),b.send()},uploadScene:function(){var a=new FileReader;a.onload=function(){var b=JSON.parse(a.result);36479732==b.checksum&&(game.scene.init(b.sceneInfo),game.hud.menu("mainMenu"))};var b=document.createElement("input");b.type="file",b.click(),b.onchange=function(c){a.readAsText(b.files[0])}},saveScene:function(){var a={checksum:36479732,sceneInfo:[]},b=function(b){for(var c=0;c<b.length;++c)a.sceneInfo.push(b[c].writeData())};b(this.scene.ground),b(this.scene.decor),b(this.scene.pickups),b(this.scene.environment),b(this.scene.enemies),b(this.scene.removed);var c=document.createElement("a");c.href=URL.createObjectURL(new Blob([JSON.stringify(a)],{type:"text/json"})),c.download="scene.json",c.click()},pause:function(){this.waitToLoad=1-game.waitToLoad,this.scene.lastTime=(new Date).getTime()}};