function webGLStart(){canvas=document.getElementById("webgl-context"),GL=initGL(),shaderProgram=initShaders(),vertexBuffer=initBuffers(),GL.clearColor(backgroundColor.r/255,backgroundColor.g/255,backgroundColor.b/255,backgroundColor.a/255),GL.viewport(0,0,GL.viewportWidth,GL.viewportHeight),GL.enable(GL.BLEND),GL.blendFunc(GL.SRC_ALPHA,GL.ONE_MINUS_SRC_ALPHA),GL.bindBuffer(GL.ARRAY_BUFFER,vertexBuffer.position),GL.vertexAttribPointer(shaderProgram.vertexPositionAttribute,vertexBuffer.position.itemSize,GL.FLOAT,!1,0,0),GL.bindBuffer(GL.ARRAY_BUFFER,vertexBuffer.textureCoord),GL.vertexAttribPointer(shaderProgram.textureCoordAttribute,vertexBuffer.textureCoord.itemSize,GL.FLOAT,!1,0,0)}function initGL(){var a;try{a=canvas.getContext("experimental-webgl"),a.viewportWidth=canvas.width,a.viewportHeight=canvas.height}catch(b){}return a?a:(alert("Could not initialise WebGL, sorry :-("),null)}function getShader(a,b){var c=document.getElementById(b);if(!c)return null;for(var d="",e=c.firstChild;e;)3==e.nodeType&&(d+=e.textContent),e=e.nextSibling;var f;if("x-shader/x-fragment"==c.type)f=a.createShader(a.FRAGMENT_SHADER);else{if("x-shader/x-vertex"!=c.type)return null;f=a.createShader(a.VERTEX_SHADER)}return a.shaderSource(f,d),a.compileShader(f),a.getShaderParameter(f,a.COMPILE_STATUS)?f:(alert(a.getShaderInfoLog(f)),null)}function initShaders(){var a=getShader(GL,"shader-fs"),b=getShader(GL,"shader-vs"),c=GL.createProgram();return GL.attachShader(c,b),GL.attachShader(c,a),GL.linkProgram(c),GL.getProgramParameter(c,GL.LINK_STATUS)||alert("Could not initialise shaders"),GL.useProgram(c),c.vertexPositionAttribute=GL.getAttribLocation(c,"aVertexPosition"),GL.enableVertexAttribArray(c.vertexPositionAttribute),c.textureCoordAttribute=GL.getAttribLocation(c,"aTextureCoord"),GL.enableVertexAttribArray(c.textureCoordAttribute),c.pMatrixUniform=GL.getUniformLocation(c,"uPMatrix"),c.mvMatrixUniform=GL.getUniformLocation(c,"uMVMatrix"),c.samplerUniform=GL.getUniformLocation(c,"uSampler"),c}function createBufferFromData(a,b,c){var d=GL.createBuffer();return GL.bindBuffer(GL.ARRAY_BUFFER,d),GL.bufferData(GL.ARRAY_BUFFER,new Float32Array(a),GL.STATIC_DRAW),d.itemSize=b,d.numItems=c,d}function initBuffers(){var a=[-squareVertexDistance,squareVertexDistance,0,squareVertexDistance,squareVertexDistance,0,-squareVertexDistance,-squareVertexDistance,0,squareVertexDistance,-squareVertexDistance,0],b=[0,1,1,1,0,0,1,0];return{position:createBufferFromData(a,3,4),textureCoord:createBufferFromData(b,2,4)}}function startGame(){webGLStart(),inputManager=new Input,textureManager.player.push(initTextureFromImage("textures/charmander.png")),textureManager.ground.push(initTextureWithColor([Math.floor(255*Math.random()),Math.floor(255*Math.random()),Math.floor(255*Math.random()),255])),textureManager.ground.push(initTextureWithColor([Math.floor(255*Math.random()),Math.floor(255*Math.random()),Math.floor(255*Math.random()),255])),loadSceneInfo("scenes/demo.json"),gameLoop()}function gameLoop(){requestAnimFrame(gameLoop),inputManager.handleInput(),scene.update(),scene.render()}function loadSceneInfo(a){var b=new XMLHttpRequest;b.onreadystatechange=function(){4==b.readyState&&(scene=new SceneManager(JSON.parse(b.responseText)))},b.open("GET",a,!0),b.send()}function mvPushMatrix(){var a=mat4.create();mat4.copy(a,mvMatrix),mvMatrixStack.push(a)}function mvPopMatrix(){if(0==mvMatrixStack.length)throw"Invalid popMatrix!";mvMatrix=mvMatrixStack.pop()}function setMatrixUniforms(){GL.uniformMatrix4fv(shaderProgram.pMatrixUniform,!1,pMatrix),GL.uniformMatrix4fv(shaderProgram.mvMatrixUniform,!1,mvMatrix)}function degToRad(a){return a*Math.PI/180}function handleLoadedTexture(a){GL.bindTexture(GL.TEXTURE_2D,a),GL.pixelStorei(GL.UNPACK_FLIP_Y_WEBGL,!0),GL.texImage2D(GL.TEXTURE_2D,0,GL.RGBA,GL.RGBA,GL.UNSIGNED_BYTE,a.image),GL.texParameteri(GL.TEXTURE_2D,GL.TEXTURE_MAG_FILTER,GL.NEAREST),GL.texParameteri(GL.TEXTURE_2D,GL.TEXTURE_MIN_FILTER,GL.NEAREST),GL.bindTexture(GL.TEXTURE_2D,null)}function initTextureFromImage(a){var b=GL.createTexture();return GL.bindTexture(GL.TEXTURE_2D,b),GL.texImage2D(GL.TEXTURE_2D,0,GL.RGBA,1,1,0,GL.RGBA,GL.UNSIGNED_BYTE,new Uint8Array([backgroundColor.r,backgroundColor.g,backgroundColor.b,backgroundColor.a])),GL.bindTexture(GL.TEXTURE_2D,null),null!=a&&(b.image=new Image,b.image.onload=function(){handleLoadedTexture(b)},b.image.src=a),b}function initTextureWithColor(a){var b=GL.createTexture();return GL.bindTexture(GL.TEXTURE_2D,b),GL.texImage2D(GL.TEXTURE_2D,0,GL.RGBA,1,1,0,GL.RGBA,GL.UNSIGNED_BYTE,new Uint8Array(a)),GL.bindTexture(GL.TEXTURE_2D,null),b}function setTexture(a){textureManager.currentTexture!=a&&(textureManager.currentTexture=a,GL.activeTexture(GL.TEXTURE0),GL.bindTexture(GL.TEXTURE_2D,a),GL.uniform1i(shaderProgram.samplerUniform,0))}var GameObject=function(a){this.position={x:0,y:0},this.drawDistance=-5,this.scale={x:1,y:1},this.texture=a,this.collider=new Collider(this,1,1)};GameObject.prototype.setPosition=function(a,b){this.position.x=a,this.position.y=b},GameObject.prototype.getPosition=function(){return{x:this.position.x,y:this.position.y}},GameObject.prototype.setScale=function(a,b){a>1&&(a=1),b>1&&(b=1),this.scale.x=a,this.scale.y=b,this.collider.w=Math.abs(a),this.collider.h=Math.abs(b)},GameObject.prototype.draw=function(){setTexture(this.texture),mvPushMatrix(),mat4.translate(mvMatrix,mvMatrix,[this.position.x,this.position.y,this.drawDistance]),mat4.scale(mvMatrix,mvMatrix,[this.scale.x,this.scale.y,1]),setMatrixUniforms(),GL.drawArrays(GL.TRIANGLE_STRIP,0,4),mvPopMatrix()};var canvas,GL,shaderProgram,vertexBuffer={position:null,textureCoord:null},squareVertexDistance=.5,currentlyPressedKeys={},Input=function(){document.onkeydown=this.handleKeyDown,document.onkeyup=this.handleKeyUp,editor&&(canvas.onmousedown=this.handleMouseDown)};Input.prototype.handleKeyDown=function(a){currentlyPressedKeys[a.keyCode]=!0},Input.prototype.handleKeyUp=function(a){currentlyPressedKeys[a.keyCode]=!1},Input.prototype.handleMouseDown=function(a){var b={x:Math.round(scene.cameraX+(a.pageX-canvas.offsetLeft-canvas.width/2)/100),y:Math.round(scene.cameraY+(a.pageY-canvas.offsetTop-canvas.height/2)/-100)};switch(a.which){case 1:scene.addObjectToScene(scene.ground,new GameObject(textureManager.ground[1]),b,{x:1,y:1});break;case 2:scene.removeObjectFromScene(scene.ground,scene.checkForCoords(scene.ground,b))}},Input.prototype.handleInput=function(){currentlyPressedKeys[39]&&scene.player.move("right"),currentlyPressedKeys[37]&&scene.player.move("left"),currentlyPressedKeys[38]&&scene.player.jump()};var scene,inputManager,backgroundColor={r:135,g:206,b:250,a:255},editor=!0,mvMatrix=mat4.create(),mvMatrixStack=[],pMatrix=mat4.create(),MovableObject=function(a,b){GameObject.call(this,a),this.rigidBody=new RigidBody(this,b)};MovableObject.prototype=Object.create(GameObject.prototype),MovableObject.prototype.constructor=MovableObject,MovableObject.prototype.update=function(){this.rigidBody.applyForce();for(var a=0;a<scene.ground.length;++a)this.position.x-scene.ground[a].position.x<=1&&this.position.y-scene.ground[a].position.y<=1&&this.collider.checkForCollision(scene.ground[a].collider)},MovableObject.prototype.move=function(a){var b=.05;"left"==a?(this.position.x-=b,this.scale.x=1):"right"==a&&(this.position.x+=b,this.scale.x=-1)},MovableObject.prototype.jump=function(){var a=.015;this.rigidBody.isGrounded?(this.rigidBody.forceY=a,this.rigidBody.isGrounded=!1):this.rigidBody.forceY=0},MovableObject.prototype.checkForDeath=function(){this.position.y<-3&&this.respawn()},MovableObject.prototype.respawn=function(){var a={x:0,y:0};this.position.x=a.x,this.position.y=a.y,this.rigidBody.isGrounded=!1,this.rigidBody.speedY=0};var RigidBody=function(a,b){this.attachedTo=a,this.mass=b,this.speedX=0,this.speedY=0,this.forceX=0,this.forceY=0,this.isGrounded=!1};RigidBody.prototype.applyForce=function(){var a=-1e-5,b=this.forceY/this.mass,c=this.forceX/this.mass;this.speedY+=(a+b)*scene.elapsed,this.speedX+=c*scene.elapsed;var d=this.attachedTo.getPosition();this.attachedTo.setPosition(d.x+this.speedX*scene.elapsed,d.y+this.speedY*scene.elapsed)},RigidBody.prototype.onGround=function(){this.isGrounded=!0,this.speedY=0};var Collider=function(a,b,c){this.attachedTo=a,this.w=b,this.h=c};Collider.prototype.checkForCollision=function(a){var b=this.attachedTo.getPosition(),c=a.attachedTo.getPosition();if(b.x-this.w/2<c.x+a.w/2&&b.x+this.w/2>c.x-a.w/2&&b.y-this.h/2<c.y+a.h/2&&b.y+this.h/2>c.y-a.h/2){var d=b.x-c.x,e=b.y-c.y;Math.abs(e)>Math.abs(d)?e>0?(this.attachedTo.rigidBody.onGround(),this.attachedTo.setPosition(b.x,c.y+(a.h+this.h)/2)):this.attachedTo.setPosition(b.x,c.y-(a.h+this.h)/2):d>0?this.attachedTo.setPosition(c.x+(a.w+this.w)/2,b.y):this.attachedTo.setPosition(c.x-(a.w+this.w)/2,b.y)}};var SceneManager=function(a){this.cameraX=0,this.cameraY=0,this.lastTime=0,this.elapsed=0,this.player=new MovableObject(textureManager.player[0],50),this.player.collider.w=.5,this.player.collider.h=.55,this.ground=[];for(var b=0;b<a.ground.length;++b){var c={x:1,y:1},d=0;a.ground[b].scale&&(c=a.ground[b].scale),a.ground[b].texture&&(d=a.ground[b].texture),this.addObjectToScene(this.ground,new GameObject(textureManager.ground[d]),a.ground[b].pos,c)}};SceneManager.prototype.addObjectToScene=function(a,b,c,d){a.push(b),a[a.length-1].setScale(d.x,d.y),a[a.length-1].setPosition(c.x,c.y-(.5-d.y/2))},SceneManager.prototype.removeObjectFromScene=function(a,b){b>-1&&b<a.length&&a.splice(b,1)},SceneManager.prototype.checkForCoords=function(a,b){for(var c=0;c<scene.ground.length;++c)if(b.x==a[c].position.x&&b.y==a[c].position.y)return c;return-1},SceneManager.prototype.prepare=function(a,b,c,d){GL.clear(GL.COLOR_BUFFER_BIT),mat4.perspective(pMatrix,a,b,c,d),mat4.identity(mvMatrix),this.cameraX=this.player.position.x,mat4.translate(mvMatrix,mvMatrix,[-this.cameraX,-this.cameraY,0])},SceneManager.prototype.render=function(){this.prepare(45,GL.viewportWidth/GL.viewportHeight,.1,100);for(var a=0;a<scene.ground.length;++a)this.ground[a].draw();this.player.draw()},SceneManager.prototype.update=function(){var a=(new Date).getTime();0!=this.lastTime&&(this.elapsed=a-this.lastTime,this.player.update()),this.lastTime=a,this.player.checkForDeath()};var textureManager={currentTexture:null,player:[],ground:[]};