function createBufferFromData(a,b,c){var d=GL.createBuffer();return GL.bindBuffer(GL.ARRAY_BUFFER,d),GL.bufferData(GL.ARRAY_BUFFER,new Float32Array(a),GL.STATIC_DRAW),d.itemSize=b,d.numItems=c,d}function initBuffers(){var a=[-squareVertexDistance,squareVertexDistance,0,squareVertexDistance,squareVertexDistance,0,-squareVertexDistance,-squareVertexDistance,0,squareVertexDistance,-squareVertexDistance,0],b=[0,1,1,1,0,0,1,0];return{position:createBufferFromData(a,3,4),textureCoord:createBufferFromData(b,2,4)}}function webGLStart(){canvas=document.getElementById("webgl-context"),GL=initGL(),shaderProgram=initShaders(),vertexBuffer=initBuffers(),GL.clearColor(backgroundColor.r/255,backgroundColor.g/255,backgroundColor.b/255,backgroundColor.a/255),GL.viewport(0,0,GL.viewportWidth,GL.viewportHeight),GL.enable(GL.BLEND),GL.blendFunc(GL.SRC_ALPHA,GL.ONE_MINUS_SRC_ALPHA),GL.bindBuffer(GL.ARRAY_BUFFER,vertexBuffer.position),GL.vertexAttribPointer(shaderProgram.vertexPositionAttribute,vertexBuffer.position.itemSize,GL.FLOAT,!1,0,0),GL.bindBuffer(GL.ARRAY_BUFFER,vertexBuffer.textureCoord),GL.vertexAttribPointer(shaderProgram.textureCoordAttribute,vertexBuffer.textureCoord.itemSize,GL.FLOAT,!1,0,0)}function initGL(){var a;try{a=canvas.getContext("experimental-webgl"),a.viewportWidth=canvas.width,a.viewportHeight=canvas.height}catch(b){}return a?a:(alert("Could not initialise WebGL, sorry :-("),null)}function getShader(a,b){var c=document.getElementById(b);if(!c)return null;for(var d="",e=c.firstChild;e;)3==e.nodeType&&(d+=e.textContent),e=e.nextSibling;var f;if("x-shader/x-fragment"==c.type)f=a.createShader(a.FRAGMENT_SHADER);else{if("x-shader/x-vertex"!=c.type)return null;f=a.createShader(a.VERTEX_SHADER)}return a.shaderSource(f,d),a.compileShader(f),a.getShaderParameter(f,a.COMPILE_STATUS)?f:(alert(a.getShaderInfoLog(f)),null)}function initShaders(){var a=getShader(GL,"shader-fs"),b=getShader(GL,"shader-vs"),c=GL.createProgram();return GL.attachShader(c,b),GL.attachShader(c,a),GL.linkProgram(c),GL.getProgramParameter(c,GL.LINK_STATUS)||alert("Could not initialise shaders"),GL.useProgram(c),c.vertexPositionAttribute=GL.getAttribLocation(c,"aVertexPosition"),GL.enableVertexAttribArray(c.vertexPositionAttribute),c.textureCoordAttribute=GL.getAttribLocation(c,"aTextureCoord"),GL.enableVertexAttribArray(c.textureCoordAttribute),c.pMatrixUniform=GL.getUniformLocation(c,"uPMatrix"),c.mvMatrixUniform=GL.getUniformLocation(c,"uMVMatrix"),c.samplerUniform=GL.getUniformLocation(c,"uSampler"),c}function startGame(){game=new Game,gameLoop()}function gameLoop(){if(requestAnimFrame(gameLoop),game.isRunning){var a=(new Date).getMilliseconds();game.editor.isOn?game.editor.handleInput():game.inputManager.handleInput(),game.scene.update(),game.scene.render();var b=(new Date).getMilliseconds();game.hud.updateFPS(b-a)}}function mvPushMatrix(){var a=mat4.create();mat4.copy(a,mvMatrix),mvMatrixStack.push(a)}function mvPopMatrix(){if(0==mvMatrixStack.length)throw"Invalid popMatrix!";mvMatrix=mvMatrixStack.pop()}function setMatrixUniforms(){GL.uniformMatrix4fv(shaderProgram.pMatrixUniform,!1,pMatrix),GL.uniformMatrix4fv(shaderProgram.mvMatrixUniform,!1,mvMatrix)}var GameObject=function(a,b){this.position=new Vector(0,0),this.drawDistance=-5,this.scale=new Vector(1,1),this.texturePool=a,this.textureIndex=b,this.collider=new Collider(this,1,1)};GameObject.prototype.setScale=function(a,b){a>1&&(a=1),b>1&&(b=1),this.scale.set(a,b),this.collider.w=Math.abs(a),this.collider.h=Math.abs(b)},GameObject.prototype.draw=function(){game.textureManager.setTexture(this.texturePool[this.textureIndex]),mvPushMatrix(),mat4.translate(mvMatrix,mvMatrix,[this.position.x,this.position.y,this.drawDistance]),mat4.scale(mvMatrix,mvMatrix,[this.scale.x,this.scale.y,1]),setMatrixUniforms(),GL.drawArrays(GL.TRIANGLE_STRIP,0,4),mvPopMatrix()};var MovableObject=function(a,b,c){GameObject.call(this,a,b),this.rigidBody=new RigidBody(this,c)};MovableObject.prototype=Object.create(GameObject.prototype),MovableObject.prototype.constructor=MovableObject,MovableObject.prototype.update=function(){this.rigidBody.applyForce();for(var a=game.scene.ground,b=0;b<a.length;++b)this.position.x-a[b].position.x<=1&&this.position.y-a[b].position.y<=1&&this.collider.checkForCollision(a[b].collider)},MovableObject.prototype.move=function(a){var b=.05;"left"==a?(this.position.x-=b,this.scale.x=1):"right"==a&&(this.position.x+=b,this.scale.x=-1)},MovableObject.prototype.jump=function(){var a=.015;this.rigidBody.isGrounded?(this.rigidBody.force.y=a,this.rigidBody.isGrounded=!1):this.rigidBody.force.y=0},MovableObject.prototype.checkForDeath=function(){(this.position.y<-3||this.position.y>6)&&this.respawn()},MovableObject.prototype.respawn=function(){var a=new Vector(0,0);this.position.set(a.x,a.y),this.rigidBody.isGrounded=!1,this.rigidBody.resetSpeedAndForce()};var Editor=function(){this.isOn=!1,this.textureIndex=0,this.switchStopper=!1};Editor.prototype.changeOnOff=function(){this.isOn=!this.isOn,this.isOn?canvas.onmousedown=this.handleMouseDown:canvas.onmousedown=null,game.hud.updateEditor(this.textureIndex+1)},Editor.prototype.changeTextureIndex=function(a){this.textureIndex+=a,-1==this.textureIndex&&(this.textureIndex+=game.textureManager.ground.length),this.textureIndex==game.textureManager.ground.length&&(this.textureIndex=0),game.hud.updateEditor(this.textureIndex+1)},Editor.prototype.handleMouseDown=function(a){var b={x:Math.round(game.scene.camera.x+(a.pageX-canvas.offsetLeft-canvas.width/2)/100),y:Math.round(game.scene.camera.y+(a.pageY-canvas.offsetTop-canvas.height/2)/-100)};switch(a.which){case 1:game.scene.addObjectToScene(game.scene.ground,new GameObject(game.textureManager.ground,game.editor.textureIndex),b,{x:1,y:1});break;case 2:game.scene.removeObjectFromScene(game.scene.ground,game.scene.checkForCoords(game.scene.ground,b))}},Editor.prototype.handleInput=function(){currentlyPressedKeys[39]&&(game.scene.camera.x+=.05),currentlyPressedKeys[37]&&(game.scene.camera.x-=.05),currentlyPressedKeys[83]&&(game.saveScene("newScene.json"),currentlyPressedKeys[83]=!1),currentlyPressedKeys[69]&&(game.editor.changeOnOff(),currentlyPressedKeys[69]=!1),currentlyPressedKeys[70]&&(this.switchStopper||(game.editor.changeTextureIndex(-1),this.switchStopper=!0)),currentlyPressedKeys[71]&&(this.switchStopper||(game.editor.changeTextureIndex(1),this.switchStopper=!0)),currentlyPressedKeys[70]||currentlyPressedKeys[71]||(this.switchStopper=!1)};var vertexBuffer={position:null,textureCoord:null},squareVertexDistance=.5,canvas,GL,backgroundColor={r:135,g:206,b:250,a:255},shaderProgram,TextureManager=function(){this.currentTexture=null,this.background=[],this.player=[],this.ground=[];var a=["grass","snow","desert"],b=a[Math.floor(3*Math.random())];this.initTexture(this.background,"textures/bg/"+b+".png"),this.initTexture(this.player,"textures/charmander.png"),this.initSpriteSheet(this.ground,"textures/tiles/"+b+".png",3,6,128,128)};TextureManager.prototype.setTexture=function(a){this.currentTexture!=a&&(this.currentTexture=a,GL.activeTexture(GL.TEXTURE0),GL.bindTexture(GL.TEXTURE_2D,a),GL.uniform1i(shaderProgram.samplerUniform,0))},TextureManager.prototype.initTexture=function(a,b){var c=GL.createTexture();GL.bindTexture(GL.TEXTURE_2D,c),GL.texImage2D(GL.TEXTURE_2D,0,GL.RGBA,1,1,0,GL.RGBA,GL.UNSIGNED_BYTE,new Uint8Array([backgroundColor.r,backgroundColor.g,backgroundColor.b,backgroundColor.a])),GL.bindTexture(GL.TEXTURE_2D,null),null!=b&&(c.image=new Image,c.image.onload=function(){GL.bindTexture(GL.TEXTURE_2D,c),GL.pixelStorei(GL.UNPACK_FLIP_Y_WEBGL,!0),GL.texImage2D(GL.TEXTURE_2D,0,GL.RGBA,GL.RGBA,GL.UNSIGNED_BYTE,c.image),GL.texParameteri(GL.TEXTURE_2D,GL.TEXTURE_MAG_FILTER,GL.NEAREST),GL.texParameteri(GL.TEXTURE_2D,GL.TEXTURE_MIN_FILTER,GL.NEAREST),GL.texParameteri(GL.TEXTURE_2D,GL.TEXTURE_WRAP_S,GL.CLAMP_TO_EDGE),GL.texParameteri(GL.TEXTURE_2D,GL.TEXTURE_WRAP_T,GL.CLAMP_TO_EDGE),GL.bindTexture(GL.TEXTURE_2D,null)},c.image.src=b),a.push(c)},TextureManager.prototype.initSpriteSheet=function(a,b,c,d,e,f){var g=new Image;g.onload=function(){for(var b=0;c>b;++b)for(var h=0;d>h;++h){var i=document.createElement("canvas"),j=i.getContext("2d");i.height=f,i.width=e,j.drawImage(g,e*h,f*b,e,f,0,0,e,f);var k=GL.createTexture();GL.bindTexture(GL.TEXTURE_2D,k),GL.pixelStorei(GL.UNPACK_FLIP_Y_WEBGL,!0),GL.texImage2D(GL.TEXTURE_2D,0,GL.RGBA,GL.RGBA,GL.UNSIGNED_BYTE,i),GL.texParameteri(GL.TEXTURE_2D,GL.TEXTURE_MAG_FILTER,GL.NEAREST),GL.texParameteri(GL.TEXTURE_2D,GL.TEXTURE_MIN_FILTER,GL.NEAREST),GL.texParameteri(GL.TEXTURE_2D,GL.TEXTURE_WRAP_S,GL.CLAMP_TO_EDGE),GL.texParameteri(GL.TEXTURE_2D,GL.TEXTURE_WRAP_T,GL.CLAMP_TO_EDGE),a.push(k)}},g.src=b};var HUD=function(){this.fps=document.createTextNode("0"),document.getElementById("fps").appendChild(this.fps),this.fps_index=0,this.fps_sum=0,this.fps_list=[],this.editor=document.createTextNode("OFF"),document.getElementById("editorMode").appendChild(this.editor),this.textureID=document.createTextNode(""),document.getElementById("textureID").appendChild(this.textureID),this.objects=document.createTextNode("0"),document.getElementById("loadedObjects").appendChild(this.objects)};HUD.prototype.updateEditor=function(a){game.editor.isOn?(this.editor.nodeValue="ON",this.textureID.nodeValue="TEXTURE: "+a):(this.editor.nodeValue="OFF",this.textureID.nodeValue="")},HUD.prototype.updateLoadedObjects=function(a){this.objects.nodeValue=a},HUD.prototype.updateFPS=function(a){this.fps_sum-=0|this.fps_list[this.fps_index],this.fps_sum+=a,this.fps_list[this.fps_index]=a,this.fps_index=(this.fps_index+1)%100,this.fps.nodeValue=(1e4/this.fps_sum).toFixed(2)};var currentlyPressedKeys={},Input=function(){document.onkeydown=this.handleKeyDown,document.onkeyup=this.handleKeyUp};Input.prototype.handleKeyDown=function(a){currentlyPressedKeys[a.keyCode]=!0},Input.prototype.handleKeyUp=function(a){currentlyPressedKeys[a.keyCode]=!1},Input.prototype.handleInput=function(){currentlyPressedKeys[39]&&game.scene.player.move("right"),currentlyPressedKeys[37]&&game.scene.player.move("left"),currentlyPressedKeys[38]&&game.scene.player.jump(),currentlyPressedKeys[82]&&(game.scene.player.respawn(),currentlyPressedKeys[82]=!1),currentlyPressedKeys[83]&&(game.saveScene("newScene.json"),currentlyPressedKeys[83]=!1),currentlyPressedKeys[69]&&(game.editor.changeOnOff(),currentlyPressedKeys[69]=!1)};var Game=function(){webGLStart(),this.scene=null,this.inputManager=new Input,this.textureManager=new TextureManager,this.hud=new HUD,this.editor=new Editor,this.isRunning=!1,this.loadScene("scenes/demo.json")};Game.prototype.loadScene=function(a){var b=this,c=new XMLHttpRequest;c.onreadystatechange=function(){4==c.readyState&&(b.scene=new SceneManager(JSON.parse(c.responseText)),b.isRunning=!0)},c.open("GET",a,!0),c.send()},Game.prototype.saveScene=function(a){for(var b={ground:[]},c=this.scene.ground,d=0;d<c.length;++d){var e={pos:{x:c[d].position.x,y:c[d].position.y}};0!=c[d].textureIndex&&(e.texture=c[d].textureIndex),(1!=c[d].scale.x||1!=c[d].scale.y)&&(e.scale={x:c[d].scale.x,y:c[d].scale.y}),b.ground.push(e)}var f=document.createElement("a"),g=new Blob([JSON.stringify(b)],{type:"text/json"});f.href=URL.createObjectURL(g),f.download=a,f.click()};var game,mvMatrix=mat4.create(),mvMatrixStack=[],pMatrix=mat4.create(),Vector=function(a,b){this.x=a,this.y=b};Vector.prototype.get=function(){return{x:this.x,y:this.y}},Vector.prototype.set=function(a,b){this.x=a,this.y=b},Vector.prototype.dot=function(a){return this.x*a.x+this.y*a.y};var RigidBody=function(a,b){this.attachedTo=a,this.mass=b,this.speed=new Vector(0,0),this.force=new Vector(0,0),this.isGrounded=!1};RigidBody.prototype.applyForce=function(){var a=game.scene.elapsed,b=-1e-5,c=new Vector(this.force.x/this.mass,this.force.y/this.mass);this.speed.set(this.speed.x+c.x*a,this.speed.y+(b+c.y)*a),this.attachedTo.position.set(this.attachedTo.position.x+this.speed.x*a,this.attachedTo.position.y+this.speed.y*a)},RigidBody.prototype.onGround=function(){this.isGrounded=!0,this.resetSpeedAndForce()},RigidBody.prototype.resetSpeedAndForce=function(){this.speed.set(0,0),this.force.set(0,0)};var Collider=function(a,b,c){this.attachedTo=a,this.w=b,this.h=c};Collider.prototype.checkForCollision=function(a){var b=this.attachedTo.position.get(),c=a.attachedTo.position.get();if(b.x-this.w/2<c.x+a.w/2&&b.x+this.w/2>c.x-a.w/2&&b.y-this.h/2<c.y+a.h/2&&b.y+this.h/2>c.y-a.h/2){var d=b.x-c.x,e=b.y-c.y;Math.abs(e)>Math.abs(d)?e>0?(this.attachedTo.rigidBody.onGround(),this.attachedTo.position.set(b.x,c.y+(a.h+this.h)/2)):this.attachedTo.position.set(b.x,c.y-(a.h+this.h)/2):d>0?this.attachedTo.position.set(c.x+(a.w+this.w)/2,b.y):this.attachedTo.position.set(c.x-(a.w+this.w)/2,b.y)}};var SceneManager=function(a){this.camera=new Vector(0,0),this.lastTime=0,this.elapsed=0,this.background=new GameObject(game.textureManager.background,0),this.background.drawDistance=-.5,this.player=new MovableObject(game.textureManager.player,0,50),this.player.collider.w=.5,this.player.collider.h=.55,this.ground=[];for(var b=0;b<a.ground.length;++b){var c={x:1,y:1},d=0;a.ground[b].scale&&(c=a.ground[b].scale),a.ground[b].texture&&(d=a.ground[b].texture),this.addObjectToScene(this.ground,new GameObject(game.textureManager.ground,d),a.ground[b].pos,c)}};SceneManager.prototype.addObjectToScene=function(a,b,c,d){a.push(b),a[a.length-1].setScale(d.x,d.y),a[a.length-1].position.set(c.x,c.y)},SceneManager.prototype.removeObjectFromScene=function(a,b){b>-1&&b<a.length&&a.splice(b,1)},SceneManager.prototype.checkForCoords=function(a,b){for(var c=0;c<this.ground.length;++c)if(b.x==a[c].position.x&&b.y==a[c].position.y)return c;return-1},SceneManager.prototype.prepare=function(a,b,c,d){GL.clear(GL.COLOR_BUFFER_BIT),mat4.perspective(pMatrix,a,b,c,d),mat4.identity(mvMatrix),game.editor.isOn||(this.camera.x=this.player.position.x),this.background.position.x=this.camera.x,mat4.translate(mvMatrix,mvMatrix,[-this.camera.x,-this.camera.y,0])},SceneManager.prototype.render=function(){this.prepare(45,GL.viewportWidth/GL.viewportHeight,.1,100);var a=0;this.background.draw(),++a;for(var b=0;b<this.ground.length;++b)Math.abs(this.ground[b].position.x-this.camera.x)<5&&(this.ground[b].draw(),++a);this.player.draw(),++a,game.hud.updateLoadedObjects(a)},SceneManager.prototype.update=function(){var a=(new Date).getTime();0!=this.lastTime&&(this.elapsed=a-this.lastTime,this.player.update()),this.lastTime=a,this.player.checkForDeath()};